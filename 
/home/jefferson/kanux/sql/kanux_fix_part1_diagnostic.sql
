
-- =====================================================
-- KANUX: Script de Verificação e Diagnóstico - PARTE 1
-- Execute no Supabase SQL Editor
-- =====================================================

-- 1. Verificar usuários no auth.users
SELECT 
  id, 
  email, 
  created_at, 
  email_confirmed_at,
  last_sign_in_at,
  raw_user_meta_data
FROM auth.users 
ORDER BY created_at DESC 
LIMIT 20;

-- 2. Verificar perfis de usuário
SELECT 
  id, 
  auth_user_id, 
  display_name, 
  email, 
  is_super_admin, 
  created_at
FROM public.user_profiles 
ORDER BY created_at DESC 
LIMIT 20;

-- 3. Ver empresas
SELECT 
  id, 
  name, 
  slug, 
  created_by, 
  created_at
FROM public.companies 
ORDER BY created_at DESC 
LIMIT 20;

-- 4. Ver membros de empresas
SELECT 
  cm.id, 
  cm.company_id, 
  cm.user_profile_id, 
  cm.role, 
  cm.joined_at,
  c.name as company_name,
  c.slug as company_slug,
  up.email as user_email,
  up.display_name as user_name
FROM public.company_members cm
JOIN public.companies c ON c.id = cm.company_id
JOIN public.user_profiles up ON up.id = cm.user_profile_id
ORDER BY cm.joined_at DESC
LIMIT 50;

-- 5. Verificar se trigger existe
SELECT 
  tgname as trigger_name, 
  proname as function_name
FROM pg_trigger t
JOIN pg_proc p ON t.tgfoid = p.oid
WHERE tgname = 'on_auth_user_created';

-- 6. Verificar RLS nas tabelas
SELECT 
  schemaname,
  tablename,
  rowsecurity
FROM pg_tables 
WHERE schemaname = 'public'
AND tablename IN ('user_profiles', 'companies', 'company_members', 'tickets', 'departments', 'chats');

-- 7. Ver políticas RLS ativas
SELECT 
  schemaname || '.' || tablename as table_name,
  policyname,
  permissive,
  roles,
  cmd
FROM pg_policies
WHERE schemaname = 'public'
ORDER BY tablename, policyname;

-- 8. Verificar chaves estrangeiras
SELECT
  tc.constraint_name,
  tc.table_name,
  kcu.column_name,
  ccu.table_name AS foreign_table_name,
  ccu.column_name AS foreign_column_name
FROM information_schema.table_constraints AS tc
JOIN information_schema.key_column_usage AS kcu
  ON tc.constraint_name = kcu.constraint_name
JOIN information_schema.constraint_column_usage AS ccu
  ON ccu.constraint_name = tc.constraint_name
WHERE tc.constraint_type = 'FOREIGN KEY'
AND tc.table_schema = 'public';

-- =====================================================
-- FIM DA PARTE 1
-- Continue para Parte 2 após verificar estes resultados
-- =====================================================

