
-- =====================================================
-- KANUX: Pol√≠ticas RLS - PARTE 3 (CONSOLIDADA)
-- Execute no Supabase SQL Editor
-- =====================================================

-- =====================================================
-- user_profiles
-- =====================================================
DROP POLICY IF EXISTS "Users can view own profile" ON public.user_profiles;
DROP POLICY IF EXISTS "Users can update own profile" ON public.user_profiles;
DROP POLICY IF EXISTS "Service role can manage profiles" ON public.user_profiles;
DROP POLICY IF EXISTS "Anyone can read profiles" ON public.user_profiles;

CREATE POLICY "Users can view own profile" ON public.user_profiles
  FOR SELECT TO authenticated
  USING (auth.uid() = auth_user_id);

CREATE POLICY "Users can update own profile" ON public.user_profiles
  FOR UPDATE TO authenticated
  USING (auth.uid() = auth_user_id);

CREATE POLICY "Anyone can read profiles" ON public.user_profiles
  FOR SELECT TO authenticated
  USING (true);

CREATE POLICY "Service role can manage profiles" ON public.user_profiles
  FOR ALL TO service_role
  USING (true) WITH CHECK (true);

-- =====================================================
-- companies
-- =====================================================
DROP POLICY IF EXISTS "Anyone can read companies" ON public.companies;
DROP POLICY IF EXISTS "Authenticated can create companies" ON public.companies;
DROP POLICY IF EXISTS "Admins can update companies" ON public.companies;

CREATE POLICY "Anyone can read companies" ON public.companies
  FOR SELECT TO authenticated USING (true);

CREATE POLICY "Authenticated can create companies" ON public.companies
  FOR INSERT TO authenticated WITH CHECK (true);

CREATE POLICY "Admins can update companies" ON public.companies
  FOR UPDATE TO authenticated
  USING (
    EXISTS (
      SELECT 1 FROM public.company_members cm
      WHERE cm.company_id = companies.id
      AND cm.user_profile_id IN (
        SELECT id FROM public.user_profiles WHERE auth_user_id = auth.uid()
      )
      AND cm.role = 'ADMIN'
    )
  );

-- =====================================================
-- company_members
-- =====================================================
DROP POLICY IF EXISTS "Members can read company members" ON public.company_members;
DROP POLICY IF EXISTS "Users can join companies" ON public.company_members;
DROP POLICY IF EXISTS "Admins can manage members" ON public.company_members;

CREATE POLICY "Members can read company members" ON public.company_members
  FOR SELECT TO authenticated
  USING (
    company_id IN (
      SELECT company_id FROM public.company_members
      WHERE user_profile_id IN (
        SELECT id FROM public.user_profiles WHERE auth_user_id = auth.uid()
      )
    )
  );

CREATE POLICY "Users can join companies" ON public.company_members
  FOR INSERT TO authenticated
  WITH CHECK (
    user_profile_id IN (
      SELECT id FROM public.user_profiles WHERE auth_user_id = auth.uid()
    )
  );

CREATE POLICY "Admins can manage members" ON public.company_members
  FOR ALL TO authenticated
  USING (
    company_id IN (
      SELECT cm2.company_id FROM public.company_members cm2
      WHERE cm2.user_profile_id IN (
        SELECT id FROM public.user_profiles WHERE auth_user_id = auth.uid()
      )
      AND cm2.role = 'ADMIN'
    )
  );

-- =====================================================
-- departments
-- =====================================================
DROP POLICY IF EXISTS "Members can read departments" ON public.departments;

CREATE POLICY "Members can read departments" ON public.departments
  FOR SELECT TO authenticated
  USING (
    company_id IN (
      SELECT company_id FROM public.company_members
      WHERE user_profile_id IN (
        SELECT id FROM public.user_profiles WHERE auth_user_id = auth.uid()
      )
    )
  );

-- =====================================================
-- chats
-- =====================================================
DROP POLICY IF EXISTS "Members can read chats" ON public.chats;

CREATE POLICY "Members can read chats" ON public.chats
  FOR SELECT TO authenticated
  USING (
    company_id IN (
      SELECT company_id FROM public.company_members
      WHERE user_profile_id IN (
        SELECT id FROM public.user_profiles WHERE auth_user_id = auth.uid()
      )
    ) OR is_private = false
  );

-- =====================================================
-- tickets
-- =====================================================
DROP POLICY IF EXISTS "Members can read tickets" ON public.tickets;
DROP POLICY IF EXISTS "Members can create tickets" ON public.tickets;
DROP POLICY IF EXISTS "Assignees can update tickets" ON public.tickets;

CREATE POLICY "Members can read tickets" ON public.tickets
  FOR SELECT TO authenticated
  USING (
    company_id IN (
      SELECT company_id FROM public.company_members
      WHERE user_profile_id IN (
        SELECT id FROM public.user_profiles WHERE auth_user_id = auth.uid()
      )
    )
  );

CREATE POLICY "Members can create tickets" ON public.tickets
  FOR INSERT TO authenticated
  WITH CHECK (
    company_id IN (
      SELECT company_id FROM public.company_members
      WHERE user_profile_id IN (
        SELECT id FROM public.user_profiles WHERE auth_user_id = auth.uid()
      )
    )
  );

CREATE POLICY "Assignees can update tickets" ON public.tickets
  FOR UPDATE TO authenticated
  USING (
    company_id IN (
      SELECT company_id FROM public.company_members
      WHERE user_profile_id IN (
        SELECT id FROM public.user_profiles WHERE auth_user_id = auth.uid()
      )
    )
  );

-- =====================================================
-- ticket_comments
-- =====================================================
DROP POLICY IF EXISTS "Members can read comments" ON public.ticket_comments;
DROP POLICY IF EXISTS "Members can create comments" ON public.ticket_comments;

CREATE POLICY "Members can read comments" ON public.ticket_comments
  FOR SELECT TO authenticated
  USING (
    ticket_id IN (
      SELECT id FROM public.tickets
      WHERE company_id IN (
        SELECT company_id FROM public.company_members
        WHERE user_profile_id IN (
          SELECT id FROM public.user_profiles WHERE auth_user_id = auth.uid()
        )
      )
    )
  );

CREATE POLICY "Members can create comments" ON public.ticket_comments
  FOR INSERT TO authenticated
  WITH CHECK (
    ticket_id IN (
      SELECT id FROM public.tickets
      WHERE company_id IN (
        SELECT company_id FROM public.company_members
        WHERE user_profile_id IN (
          SELECT id FROM public.user_profiles WHERE auth_user_id = auth.uid()
        )
      )
    )
  );

-- =====================================================
-- GRANTS
-- =====================================================
GRANT SELECT ON public.user_profiles TO authenticated;
GRANT SELECT ON public.companies TO authenticated;
GRANT SELECT ON public.company_members TO authenticated;
GRANT SELECT ON public.departments TO authenticated;
GRANT SELECT ON public.chats TO authenticated;
GRANT SELECT ON public.tickets TO authenticated;
GRANT SELECT ON public.ticket_comments TO authenticated;

GRANT INSERT ON public.user_profiles TO authenticated;
GRANT INSERT ON public.companies TO authenticated;
GRANT INSERT ON public.company_members TO authenticated;
GRANT INSERT ON public.tickets TO authenticated;
GRANT INSERT ON public.ticket_comments TO authenticated;

GRANT UPDATE ON public.user_profiles TO authenticated;
GRANT UPDATE ON public.companies TO authenticated;
GRANT UPDATE ON public.tickets TO authenticated;
GRANT UPDATE ON public.ticket_comments TO authenticated;

